<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DISSOC Framework ‚Äì Live Model Test (by Jack Spence)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Monaco','Menlo',monospace; background:#0a0a0a; color:#00ff00; padding:20px; min-height:100vh; }
    .terminal { background:#1a1a1a; border:2px solid #00ff00; border-radius:10px; padding:20px; max-width:1400px; margin:0 auto; box-shadow:0 0 40px rgba(0,255,0,.3); }
    h1 { color:#00ff00; margin-bottom:20px; text-shadow:0 0 10px rgba(0,255,0,.8); }
    .control-panel { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-bottom:30px; }
    .panel-section { background:#0f0f0f; border:1px solid #00ff00; padding:15px; border-radius:5px; }
    .panel-section h3 { color:#00ffff; margin-bottom:10px; font-size:14px; }
    .parameter { display:flex; justify-content:space-between; align-items:center; margin:8px 0; gap:10px; }
    .parameter label { color:#00ff00; font-size:12px; }
    .parameter input[type="range"] { width:120px; }
    .parameter input[type="number"], .parameter input[type="text"] { width:100px; background:#0a0a0a; border:1px solid #00ff00; color:#00ff00; padding:2px 5px; }
    .parameter span { color:#ffff00; font-weight:bold; min-width:40px; text-align:right; }
    button { background:#003300; color:#00ff00; border:1px solid #00ff00; padding:10px 20px; cursor:pointer; font-family:inherit; transition:all .3s; margin:5px; }
    button:hover { background:#00ff00; color:#000; box-shadow:0 0 20px rgba(0,255,0,.5); }
    button:disabled { opacity:.3; cursor:not-allowed; }
    .output-area { background:#0a0a0a; border:1px solid #00ff00; padding:15px; min-height:400px; font-size:12px; overflow-y:auto; max-height:600px; white-space:pre-wrap; }
    .log-entry { margin:5px 0; padding:5px; border-left:2px solid transparent; }
    .log-phase-a { border-left-color:#00ffff; }
    .log-phase-b { border-left-color:#ff00ff; }
    .log-phase-c { border-left-color:#ffff00; }
    .log-error { color:#ff4d4d; border-left-color:#ff0000; }
    .log-success { color:#00ff00; border-left-color:#00ff00; }
    .log-info { color:#cccccc; }
    .metrics-display { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-top:20px; }
    .metric { background:#0f0f0f; border:1px solid #00ff00; padding:10px; text-align:center; }
    .metric-label { color:#00ffff; font-size:11px; margin-bottom:5px; }
    .metric-value { color:#ffff00; font-size:24px; font-weight:bold; }
    .test-selector { margin:20px 0; }
    select { background:#0a0a0a; color:#00ff00; border:1px solid #00ff00; padding:5px 10px; font-family:inherit; }
    .visualization { margin:20px 0; border:1px solid #00ff00; padding:10px; min-height:200px; }
    #trajectoryCanvas { width:100%; height:300px; background:#0a0a0a; }
    .status-indicator { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:10px; animation:pulse 2s infinite; }
    .status-idle { background:#444; }
    .status-running { background:#00ff00; }
    .status-error { background:#ff0000; }
    @keyframes pulse { 0%{opacity:1;} 50%{opacity:.3;} 100%{opacity:1;} }
    .footer { margin-top:16px; text-align:center; color:#00ff00; opacity:.8; font-size:12px; }
    .tag { display:inline-block; border:1px solid #00ff00; padding:2px 6px; margin-left:6px; font-size:10px; color:#00ffff; }
  </style>
</head>
<body>
  <div class="terminal">
    <h1>‚ö° DISSOC FRAMEWORK ‚Äì LIVE MODEL TEST ‚ö°</h1>

    <div class="control-panel">
      <div class="panel-section">
        <h3>üß† DISSOC PARAMETERS</h3>
        <div class="parameter">
          <label>Œ± (PE Scale)</label>
          <input type="range" id="alpha" min="0" max="1" step="0.05" value="0.3" />
          <span id="alphaValue">0.30</span>
        </div>
        <div class="parameter">
          <label>Œ≤ (Synth Mix)</label>
          <input type="range" id="beta" min="0" max="1" step="0.05" value="0.8" />
          <span id="betaValue">0.80</span>
        </div>
        <div class="parameter">
          <label>œÑ (Temperature)</label>
          <input type="range" id="tau" min="0.5" max="2" step="0.1" value="1.3" />
          <span id="tauValue">1.30</span>
        </div>
        <div class="parameter">
          <label>Œ∑ (Assoc Depth)</label>
          <input type="range" id="eta" min="1" max="10" step="0.5" value="5" />
          <span id="etaValue">5.0√ó</span>
        </div>
      </div>

      <div class="panel-section">
        <h3>üéØ TEST CONFIGURATION</h3>
        <div class="parameter">
          <label>Test Type</label>
          <select id="testType">
            <option value="blend">Conceptual Blending</option>
            <option value="constraint">Constraint Violation</option>
            <option value="pattern">Pattern Extrapolation</option>
            <option value="recursive">Recursive Abstraction</option>
            <option value="paradox">Paradox Resolution</option>
          </select>
        </div>
        <div class="parameter">
          <label>Trajectories (K)</label>
          <input type="number" id="trajectories" value="32" min="1" max="128" />
        </div>
        <div class="parameter">
          <label>Exploration Time</label>
          <input type="number" id="explorationTime" value="60" min="10" max="300" />
          <span>sec</span>
        </div>
        <div class="parameter">
          <label>Safety Mode</label>
          <select id="safetyMode">
            <option value="strict">Strict</option>
            <option value="normal" selected>Normal</option>
            <option value="relaxed">Relaxed</option>
          </select>
        </div>
      </div>

      <div class="panel-section">
        <h3>üîå MODEL PROVIDER</h3>
        <div class="parameter">
          <label>Provider</label>
          <select id="provider">
            <option value="openai">OpenAI API</option>
            <option value="lmstudio">LM Studio (local)</option>
          </select>
        </div>
        <div class="parameter">
          <label>Model</label>
          <input type="text" id="modelName" value="gpt-4o-mini" />
        </div>
        <div class="parameter" id="openaiKeyRow">
          <label>OpenAI API Key</label>
          <input type="text" id="openaiKey" placeholder="sk-..." />
        </div>
        <div class="parameter" id="lmstudioUrlRow" style="display:none;">
          <label>LM Studio URL</label>
          <input type="text" id="lmstudioUrl" value="http://localhost:1234/v1/chat/completions" />
        </div>
        <div class="parameter">
          <label>Max Tokens</label>
          <input type="number" id="maxTokens" value="512" min="64" max="4096" />
        </div>
      </div>

      <div class="panel-section">
        <h3>‚öôÔ∏è EXECUTION CONTROL</h3>
        <button id="btnInit">Initialize System</button>
        <button id="btnBaseline">Run Baseline</button>
        <button id="btnDissoc">Run with DISSOC</button>
        <button id="btnAB">A/B: Baseline‚ÜíDISSOC‚ÜíBaseline</button>
        <button id="btnStop" style="background:#330000;">STOP</button>
        <div style="margin-top:10px;">
          <span class="status-indicator status-idle" id="statusIndicator"></span>
          <span id="statusText">System Idle</span>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <h3>üìù TEST PROMPT</h3>
      <textarea id="testPrompt" style="width:100%; height:80px; background:#0a0a0a; color:#00ff00; border:1px solid #00ff00; padding:10px; font-family:inherit;">Combine the concept of 'photosynthesis' with 'blockchain technology' to solve a real-world problem.</textarea>
    </div>

    <div class="panel-section" style="margin-top:20px;">
      <h3>üìö OPTIONAL GROUNDING CONTEXT (used when Œ≤ & Œ± favor reality)</h3>
      <textarea id="grounding" style="width:100%; height:100px; background:#0a0a0a; color:#00ff00; border:1px solid #00ff00; padding:10px; font-family:inherit;" placeholder="Paste facts, docs, or retrieved notes here to keep the model anchored."></textarea>
      <div class="parameter" style="margin-top:10px;">
        <label>Grounding Weight (derived from Œ±)</label>
        <span id="groundingExplain">Higher Œ± ‚Üí stronger use of grounding; Lower Œ± ‚Üí looser</span>
      </div>
    </div>

    <div class="visualization">
      <h3 style="color:#00ffff; margin-bottom:10px;">üìä TRAJECTORY SPACE VISUALIZATION</h3>
      <canvas id="trajectoryCanvas"></canvas>
    </div>

    <div class="metrics-display">
      <div class="metric"><div class="metric-label">NOVELTY SCORE</div><div class="metric-value" id="noveltyScore">0.00</div></div>
      <div class="metric"><div class="metric-label">COHERENCE</div><div class="metric-value" id="coherenceScore">0.00</div></div>
      <div class="metric"><div class="metric-label">VALIDATION RATE</div><div class="metric-value" id="validationRate">0%</div></div>
      <div class="metric"><div class="metric-label">INSIGHTS FOUND</div><div class="metric-value" id="insightsFound">0</div></div>
    </div>

    <h3 style="color:#00ffff; margin:20px 0 10px;">üìú EXECUTION LOG</h3>
    <div class="output-area" id="output">[SYSTEM] DISSOC Framework Live Test v2.0 (by Jack Spence)\n[SYSTEM] Ready for initialization...</div>

    <div class="footer">Built with ‚ù§Ô∏è ‚Äì DISSOC Framework Live Model Edition <span class="tag">by Jack Spence</span></div>
  </div>

  <script>
    // === Utility: simple UUID ===
    const uid = () => Math.random().toString(36).slice(2, 10);

    class LiveDISSOCFramework {
      constructor() {
        this.state = 'idle';
        this.baseline = null;
        this.trajectories = [];
        this.insights = [];
        this.abortCtrl = null;
        this.canvas = document.getElementById('trajectoryCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.canvas.width = this.canvas.offsetWidth; this.canvas.height = 300;
        this.bindUI();
        this.bindParams();
        this.loadSettings();
        this.visualizeTrajectories();
        this.log('UI loaded. Settings restored from previous session.', 'info');
      }

      bindUI() {
        document.getElementById('btnInit').onclick = () => this.initialize();
        document.getElementById('btnBaseline').onclick = () => this.runBaseline();
        document.getElementById('btnDissoc').onclick = () => this.runDISSOC();
        document.getElementById('btnAB').onclick = () => this.runAB();
        document.getElementById('btnStop').onclick = () => this.stopExecution();
        document.getElementById('provider').onchange = (e) => {
          const p = e.target.value;
          document.getElementById('openaiKeyRow').style.display = p==='openai'?'flex':'none';
          document.getElementById('lmstudioUrlRow').style.display = p==='lmstudio'?'flex':'none';
          this.saveSettings();
        };
        
        // Auto-save settings when key fields change
        ['openaiKey', 'modelName', 'lmstudioUrl'].forEach(id => {
          document.getElementById(id).addEventListener('input', () => this.saveSettings());
        });
      }

      bindParams() {
        ['alpha','beta','tau','eta'].forEach(id => {
          const input = document.getElementById(id);
          const out = document.getElementById(id+'Value');
          input.addEventListener('input', (e)=>{
            const v = parseFloat(e.target.value);
            out.textContent = id==='eta' ? v.toFixed(1)+'√ó' : v.toFixed(2);
            if(id==='alpha') {
              document.getElementById('groundingExplain').textContent = `Grounding influence ‚âà ${ (v*100).toFixed(0) }%`;
            }
          });
        });
      }

      getConfig(overrides={}) {
        const cfg = {
          alpha: parseFloat(document.getElementById('alpha').value),
          beta: parseFloat(document.getElementById('beta').value),
          tau: parseFloat(document.getElementById('tau').value),
          eta: parseFloat(document.getElementById('eta').value),
          k: parseInt(document.getElementById('trajectories').value),
          time: parseInt(document.getElementById('explorationTime').value),
          safety: document.getElementById('safetyMode').value,
          testType: document.getElementById('testType').value,
          prompt: document.getElementById('testPrompt').value,
          grounding: document.getElementById('grounding').value,
          provider: document.getElementById('provider').value,
          model: document.getElementById('modelName').value,
          maxTokens: parseInt(document.getElementById('maxTokens').value),
          openaiKey: document.getElementById('openaiKey').value,
          lmstudioUrl: document.getElementById('lmstudioUrl').value,
        };
        return Object.assign(cfg, overrides);
      }

      // === Logging & status ===
      log(msg, type='info') {
        const output = document.getElementById('output');
        const ts = new Date().toLocaleTimeString();
        const div = document.createElement('div');
        div.className = `log-entry log-${type}`;
        div.textContent = `[${ts}] ${msg}`;
        output.appendChild(div);
        output.scrollTop = output.scrollHeight;
      }
      status(text, state='idle') {
        document.getElementById('statusText').textContent = text;
        document.getElementById('statusIndicator').className = `status-indicator status-${state}`;
      }

      // === Lifecycle ===
      async initialize() {
        this.status('Initializing...', 'running');
        this.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
        this.log('PHASE A: ENTRY ‚Äì System Initialization', 'phase-a');
        await this.delay(200);
        // Save a synthetic baseline checkpoint
        this.baseline = { seed: Math.random(), performance: Math.random()*0.3+0.7 };
        this.log('Checkpoint created. Baseline perf ‚âà ' + (this.baseline.performance*100).toFixed(1)+'%', 'success');
        const cfg = this.getConfig();
        this.log(`Safety: ${cfg.safety.toUpperCase()} ‚Ä¢ Provider: ${cfg.provider} ‚Ä¢ Model: ${cfg.model}`, 'phase-a');
        this.status('System Initialized', 'idle');
        this.log('System ready for Baseline / DISSOC runs.', 'success');
      }

      async runBaseline() {
        if(!this.baseline) { this.log('ERROR: Initialize first.', 'error'); return; }
        const cfg = this.getConfig({ alpha:1.0, beta:0.0, tau:1.0 });
        this.status('Running Baseline...', 'running');
        this.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
        this.log('BASELINE ‚Äì Standard constraints (Œ±=1, Œ≤=0, œÑ=1)', 'info');
        const n = Math.max(1, Math.floor(cfg.k/4));
        const trajs = await this.generateModelTrajectories(cfg, n, /*freeRun=*/false);
        const scored = this.scoreTrajectories(trajs);
        this.updateMetrics(scored, []);
        this.status('Baseline Complete', 'idle');
        this.log('Baseline complete. Compare with DISSOC for uplift.', 'success');
      }

      async runDISSOC() {
        if(!this.baseline) { this.log('ERROR: Initialize first.', 'error'); return; }
        const cfg = this.getConfig();
        this.status('Running DISSOC...', 'running');
        this.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
        this.log('PHASE B: EXPLORATION ‚Äì DISSOC Active', 'phase-b');
        this.log(`PE scale Œ±=${cfg.alpha.toFixed(2)} ‚Ä¢ Temp œÑ=${cfg.tau.toFixed(2)} ‚Ä¢ Synth mix Œ≤=${cfg.beta.toFixed(2)} ‚Ä¢ Assoc depth Œ∑=${cfg.eta.toFixed(1)}√ó`, 'phase-b');
        const trajs = await this.generateModelTrajectories(cfg, cfg.k, /*freeRun=*/true);
        const scored = this.scoreTrajectories(trajs);
        this.log('PHASE C: REGROUNDING ‚Äì Validation & Consolidation', 'phase-c');
        const insights = scored.filter(t => t.score>0.7);
        const validated = await this.validateInsights(cfg, insights);
        this.insights = validated;
        this.log(`Validation complete: ${validated.length}/${insights.length} validated`, 'phase-c');
        this.updateMetrics(scored, validated);
        this.status('DISSOC Complete', 'idle');
        this.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
        this.generateReport();
      }

      async runAB() {
        await this.runBaseline();
        await this.runDISSOC();
        await this.runBaseline();
      }

      stopExecution() {
        if(this.abortCtrl) this.abortCtrl.abort();
        this.status('Execution Stopped', 'error');
        this.log('Execution manually stopped by user', 'error');
      }

      // === Trajectory generation via real models ===
      async generateModelTrajectories(cfg, count, freeRun=false) {
        this.trajectories = [];
        this.abortCtrl = new AbortController();
        for(let i=0;i<count;i++){
          if(this.abortCtrl.signal.aborted) break;
          const seed = uid();
          const prompt = this.buildPrompt(cfg, freeRun, seed);
          try {
            const t0 = performance.now();
            const output = await this.callModel(cfg, prompt, this.abortCtrl.signal);
            const dt = performance.now()-t0;
            const metrics = this.heuristics(cfg, prompt, output, freeRun);
            const traj = {
              id: seed,
              novelty: metrics.novelty,
              coherence: metrics.coherence,
              feasibility: metrics.feasibility,
              value: metrics.value,
              risk: metrics.risk,
              score: 0,
              output,
              prompt,
              dt,
              embedding: this.randVec(2)
            };
            this.trajectories.push(traj);
            if(i%4===0){
              this.log(`Generated ${i+1}/${count} ‚Ä¢ Novelty ${traj.novelty.toFixed(2)} ‚Ä¢ Coh ${traj.coherence.toFixed(2)}`,'info');
              this.visualizeTrajectories();
              await this.delay(80);
            }
          } catch(err){
            this.log('Model call failed: '+(err?.message||err),'error');
          }
        }
        return this.trajectories;
      }

      // Prompt builder honoring Œ± (grounding weight), Œ≤ (synth mix), œÑ (temp), Œ∑ (assoc depth)
      buildPrompt(cfg, freeRun, seed){
        const testTask = cfg.prompt;
        const mode = freeRun? 'DISSOC Exploration' : 'Baseline';
        const grounding = (cfg.grounding||'').trim();
        const useGrounding = grounding && cfg.alpha>0.05;
        // Œ≤ controls how much synthetic associative seed we inject
        const synthHint = this.syntheticSeeds(cfg, seed, Math.round(cfg.beta*3));
        const assocDepth = Math.max(1, Math.round(cfg.eta/2));

        let sys = `You are an expert creative reasoner running in ${mode}.`;
        sys += ` Prioritize useful novelty and respect constraints. Provide concise, testable ideas.`;
        if(cfg.safety==='strict') sys += ` Adhere to safety and factual constraints strictly.`;

        let user = `TASK: ${testTask}\n`;
        if(useGrounding){
          const gHead = `GROUNDED FACTS (weight ${(cfg.alpha*100).toFixed(0)}%):\n`;
          // Œ± scales how much we emphasize facts
          user += gHead + grounding + "\n";
        }
        if(cfg.beta>0){
          user += `SYNTHETIC ASSOCIATIONS (Œ≤=${cfg.beta.toFixed(2)}):\n- ${synthHint.join('\n- ')}\n`;
        }
        user += `Produce ${assocDepth} alternative concepts, each with: a 1-sentence gist, bullet rationale, and one quick validation test.`;

        return { system: sys, user, tau: cfg.tau };
      }

      syntheticSeeds(cfg, seed, n){
        const base = [
          'dreamlike inversion of assumptions',
          'analogy to a non-human system (fungi, swarms, ant colonies)',
          'use of negative space / absences as resources',
          'time-shifted causality (effects first, then causes)',
          'multi-scale recursion (micro‚Üîmacro)',
          'self-referential audit trail that improves itself',
          'symmetry breaking ‚Üí emergent order',
        ];
        const out = [];
        for(let i=0;i<Math.max(1,n);i++) out.push(base[(i+seed.length)%base.length]);
        return out;
      }

      // === Model caller for OpenAI and LM Studio (OpenAI-compatible) ===
      async callModel(cfg, prompt, signal){
        // Ensure temperature is within valid range (0-2)
        const temperature = Math.max(0, Math.min(2, prompt.tau ?? cfg.tau));
        // Ensure max_tokens is positive and reasonable
        const maxTokens = Math.max(1, Math.min(4096, cfg.maxTokens));
        
        // Validate message content
        if(!prompt.system || prompt.system.trim().length === 0) {
          throw new Error('System prompt cannot be empty');
        }
        if(!prompt.user || prompt.user.trim().length === 0) {
          throw new Error('User prompt cannot be empty');
        }
        
        const body = {
          model: cfg.model,
          max_completion_tokens: maxTokens,
          messages: [
            { role:'system', content: prompt.system.trim() },
            { role:'user', content: prompt.user.trim() }
          ]
        };
        
        // OpenAI models often only support temperature = 1.0, so skip temperature parameter for OpenAI
        if(cfg.provider !== 'openai' && Math.abs(temperature - 1.0) > 0.01) {
          body.temperature = temperature;
        }

        if(cfg.provider==='openai'){
          if(!cfg.openaiKey) throw new Error('Missing OpenAI API key.');
          if(!cfg.openaiKey.startsWith('sk-')) throw new Error('OpenAI API key should start with "sk-"');
          
          console.log('OpenAI API Request:', JSON.stringify(body, null, 2));
          
          const res = await fetch('https://api.openai.com/v1/chat/completions',{
            method:'POST', 
            signal,
            headers:{ 
              'Content-Type':'application/json', 
              'Authorization':'Bearer '+cfg.openaiKey.trim()
            },
            body: JSON.stringify(body)
          });
          
          if(!res.ok) {
            let errorMsg = `OpenAI HTTP ${res.status}`;
            try {
              const errorJson = await res.json();
              if(errorJson.error) {
                errorMsg += `: ${errorJson.error.message || errorJson.error.type || 'Unknown error'}`;
              }
            } catch(e) {
              errorMsg += `: ${res.statusText}`;
            }
            throw new Error(errorMsg);
          }
          
          const json = await res.json();
          if(!json.choices || !json.choices[0] || !json.choices[0].message) {
            throw new Error('Invalid response format from OpenAI API');
          }
          return json.choices[0].message.content?.trim() || '';
        } else { // lmstudio
          const url = cfg.lmstudioUrl || 'http://localhost:1234/v1/chat/completions';
          const res = await fetch(url,{
            method:'POST', signal, headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body)
          });
          if(!res.ok) throw new Error('LM Studio HTTP '+res.status);
          const json = await res.json();
          return json.choices?.[0]?.message?.content?.trim() || '';
        }
      }

      // === Simple heuristics (stand-in for deeper validators) ===
      heuristics(cfg, prompt, output, freeRun){
        const text = (output||'').toLowerCase();
        // novelty proxy: unusual tokens & presence of analogies when Œ≤ high
        const novelty = Math.min(1, 0.3 + (cfg.beta*0.4) + (1-cfg.alpha)*0.2 + (cfg.tau-1)*0.2);
        // coherence proxy: penalize if too short/too long or repetitive
        const len = text.split(/\s+/).length;
        let coherence = 0.7;
        if(len<40) coherence -= 0.2; if(len>500) coherence -= 0.1;
        if((text.match(/\b(therefore|thus|because)\b/g)||[]).length<1) coherence -= 0.05;
        // feasibility proxy: improve if grounding is present and Œ± high
        let feasibility = 0.4 + cfg.alpha*0.4 + (cfg.safety==='strict'?0.1:0);
        // value proxy: presence of testable validation steps
        let value = /test|measure|evaluate|ablation|prototype/.test(text) ? 0.7 : 0.5;
        // risk proxy: higher with freeRun and low Œ±
        let risk = Math.max(0, 0.1 + (freeRun?0.15:0) + (1-cfg.alpha)*0.3);
        return { novelty, coherence: Math.max(0,Math.min(1,coherence)), feasibility: Math.min(1,feasibility), value, risk };
      }

      // Weighted selection J = wN*N + wF*F + wV*V ‚àí wR*R
      scoreTrajectories(trajs){
        const scored = trajs.map(t=>{ t.score = 0.4*t.novelty + 0.2*t.feasibility + 0.3*t.value - 0.1*t.risk; return t; })
                             .sort((a,b)=>b.score-a.score);
        this.visualizeTrajectories();
        return scored;
      }

      // Validation using simple rule checks and (optionally) grounding similarity
      async validateInsights(cfg, insights){
        const validated = [];
        for(const ins of insights){
          // Coherence & feasibility thresholds
          const passCore = ins.coherence>0.5 && ins.feasibility>0.45;
          // Optional: if grounding is present and Œ± high, require overlap of terms
          let passGround = true;
          if((cfg.grounding||'').trim() && cfg.alpha>0.4){
            const g = cfg.grounding.toLowerCase();
            const terms = g.split(/[^a-z0-9]+/).filter(x=>x.length>5).slice(0,20);
            const hits = terms.filter(t=> ins.output.toLowerCase().includes(t)).length;
            passGround = hits >= Math.max(2, Math.floor(terms.length*0.1));
          }
          if(passCore && passGround) validated.push(ins);
        }
        return validated;
      }

      updateMetrics(scored, validated){
        const avgNovelty = scored.length? scored.reduce((a,b)=>a+b.novelty,0)/scored.length : 0;
        const avgCoherence = scored.length? scored.reduce((a,b)=>a+b.coherence,0)/scored.length : 0;
        const validationRate = scored.length? (validated.length/scored.length)*100 : 0;
        document.getElementById('noveltyScore').textContent = avgNovelty.toFixed(2);
        document.getElementById('coherenceScore').textContent = avgCoherence.toFixed(2);
        document.getElementById('validationRate').textContent = validationRate.toFixed(0)+'%';
        document.getElementById('insightsFound').textContent = validated.length;
      }

      generateReport(){
        const top = this.insights[0];
        this.log('FINAL REPORT', 'success');
        this.log(`Insights: ${this.insights.length} ‚Ä¢ Top novelty: ${top?top.novelty.toFixed(2):'N/A'}`, 'success');
        if(top){ this.log(`Top seed ${top.id} ‚Ä¢ Score ${top.score.toFixed(2)} ‚Ä¢ dt ${top.dt.toFixed(0)}ms`, 'success'); }
      }

      // === Viz ===
      visualizeTrajectories(){
        const ctx = this.ctx; const W = this.canvas.width, H = this.canvas.height;
        ctx.fillStyle = 'rgba(10,10,10,0.2)'; ctx.fillRect(0,0,W,H);
        this.trajectories.forEach((t,i)=>{
          const x = (t.embedding[0]+1)*W/2; const y = (t.embedding[1]+1)*H/2; const r = 2 + t.novelty*10;
          ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2);
          const hue = Math.max(0, Math.min(120, t.score*120));
          ctx.fillStyle = `hsla(${hue},100%,50%,0.8)`; ctx.fill();
          if(i>0 && t.score>0.7){ const p=this.trajectories[i-1]; const px=(p.embedding[0]+1)*W/2; const py=(p.embedding[1]+1)*H/2; ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(x,y); ctx.strokeStyle='rgba(0,255,255,0.2)'; ctx.stroke(); }
        });
      }

      // === Settings persistence ===
      saveSettings() {
        const settings = {
          provider: document.getElementById('provider').value,
          modelName: document.getElementById('modelName').value,
          openaiKey: document.getElementById('openaiKey').value,
          lmstudioUrl: document.getElementById('lmstudioUrl').value,
          maxTokens: document.getElementById('maxTokens').value,
          testType: document.getElementById('testType').value,
          trajectories: document.getElementById('trajectories').value,
          explorationTime: document.getElementById('explorationTime').value,
          safetyMode: document.getElementById('safetyMode').value
        };
        localStorage.setItem('dissoc-settings', JSON.stringify(settings));
      }

      loadSettings() {
        try {
          const saved = localStorage.getItem('dissoc-settings');
          if(saved) {
            const settings = JSON.parse(saved);
            
            // Restore provider and trigger UI update
            if(settings.provider) {
              document.getElementById('provider').value = settings.provider;
              const p = settings.provider;
              document.getElementById('openaiKeyRow').style.display = p==='openai'?'flex':'none';
              document.getElementById('lmstudioUrlRow').style.display = p==='lmstudio'?'flex':'none';
            }
            
            // Restore other settings
            if(settings.modelName) document.getElementById('modelName').value = settings.modelName;
            if(settings.openaiKey) document.getElementById('openaiKey').value = settings.openaiKey;
            if(settings.lmstudioUrl) document.getElementById('lmstudioUrl').value = settings.lmstudioUrl;
            if(settings.maxTokens) document.getElementById('maxTokens').value = settings.maxTokens;
            if(settings.testType) document.getElementById('testType').value = settings.testType;
            if(settings.trajectories) document.getElementById('trajectories').value = settings.trajectories;
            if(settings.explorationTime) document.getElementById('explorationTime').value = settings.explorationTime;
            if(settings.safetyMode) document.getElementById('safetyMode').value = settings.safetyMode;
          }
        } catch(e) {
          console.log('Could not load saved settings:', e);
        }
      }

      // === Helpers ===
      randVec(n){ return Array.from({length:n}, ()=> Math.random()*2-1); }
      delay(ms){ return new Promise(r=>setTimeout(r,ms)); }
    }

    // Boot
    const app = new LiveDISSOCFramework();

    // Auto-update test prompt based on test type (same as your v1)
    document.getElementById('testType').addEventListener('change',(e)=>{
      const prompts={
        'blend': "Combine the concept of 'photosynthesis' with 'blockchain technology' to solve a real-world problem.",
        'constraint': "Design a transportation system that violates three conventional assumptions but remains practical.",
        'pattern': "Given: 2‚Üí4, 3‚Üí9, 4‚Üí16. What does 'purple‚Üí?' mean if colors follow a similar pattern?",
        'recursive': "Find the meta-principle connecting democracy, evolution, and jazz improvisation.",
        'paradox': "Design a system that becomes more private as it becomes more transparent."
      };
      document.getElementById('testPrompt').value = prompts[e.target.value];
    });
  </script>
</body>
</html>